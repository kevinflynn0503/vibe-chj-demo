# 产品功能架构 - 漕河泾智能驾驶舱

> 日期：2026-02-09
> 阶段：Phase 3 产品设计

---

## 一、整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    小北驾驶舱平台                          │
│                                                          │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────────┐ │
│  │ 客户拜访 App  │ │ 政策服务 App  │ │ 孵化器管理 App   │ │
│  │  (走访全流程) │ │ (高新认定)    │ │ (订单匹配)       │ │
│  └──────┬───────┘ └──────┬───────┘ └────────┬─────────┘ │
│         │                │                   │           │
│  ┌──────┴────────────────┴───────────────────┴────────┐  │
│  │              公共企业画像模块                         │  │
│  │      (三个 App 共享同一套企业画像页)                  │  │
│  └───────────────────────┬────────────────────────────┘  │
│                          │                               │
│  ────────────────────────┼─────────────────────────────  │
│                          │                               │
│  ┌───────────┐ ┌────────┴──────┐ ┌───────────────────┐  │
│  │ 背调 Agent │ │ 政策筛选Agent │ │ 订单匹配 Agent    │  │
│  │ 走访提取   │ │ 政策诊断      │ │ 关系分析          │  │
│  └─────┬─────┘ └──────┬───────┘ └─────────┬─────────┘  │
│        │              │                    │             │
│  ┌─────┴──────────────┴────────────────────┴──────────┐  │
│  │               共用 Sub-Agent / 工具                  │  │
│  │  deep_research │ feishu_agent │ supabase_tool       │  │
│  └────────────────────────┬───────────────────────────┘  │
│                           │                              │
│  ─────────────────────────┼────────────────────────────  │
│                           │                              │
│  ┌────────────────────────┴───────────────────────────┐  │
│  │                   Supabase 数据库                    │  │
│  │  enterprises │ visits │ policies │ matches │ ...    │  │
│  └────────────────────────┬───────────────────────────┘  │
│                           │                              │
│  ┌────────────────────────┴───────────────────────────┐  │
│  │              上下文平台（数据接入层）                  │  │
│  │  飞书API │ 企业数据库 │ 企查查 │ 访客系统 │ ...     │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

## 二、三个 App + 公共模块

| App | 核心用户 | 核心功能 | 页面数（估） |
|-----|---------|---------|------------|
| 客户拜访 App | 招商经理 | 背调生成 → 走访记录 → 需求闭环 | 6-8 页 |
| 政策服务 App | 项目经理/科创 | 企业筛选 → 触达分发 → 申报诊断 | 5-7 页 |
| 孵化器管理 App | 孵化器运营 | 运营监控 → 订单匹配 → 关系可视化 | 4-5 页 |
| **公共企业画像** | 全部用户 | 企业详情页（多 Tab） | 1 页（多 Tab） |

### 公共企业画像模块

三个 App 共享同一个企业画像详情页。不同 App 看到的 Tab 不同：

| Tab | 客户拜访 | 政策服务 | 孵化器 | 说明 |
|-----|---------|---------|--------|------|
| 基本信息 | ✅ | ✅ | ✅ | 工商/股权/融资/团队/产品 |
| 走访记录 | ✅ | ✅ | — | 所有部门的历史走访 |
| 政策状态 | — | ✅ | — | 初筛/分级/触达/诊断进度 |
| 服务记录 | ✅ | — | — | 服务包/合同/历史服务 |
| 合作关系 | — | — | ✅ | 产业链关系/订单匹配 |
| 需求清单 | ✅ | — | — | 企业诉求及处理状态 |

---

## 三、数据模型

### 3.1 核心表结构

```sql
-- ========================================
-- 企业画像主表（三场景共用）
-- ========================================
CREATE TABLE enterprises (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,                    -- 企业全名
  short_name TEXT,                       -- 简称
  unified_code TEXT UNIQUE,              -- 统一社会信用代码
  registered_address TEXT,               -- 注册地址
  office_address TEXT,                   -- 办公地址
  legal_person TEXT,                     -- 法人代表
  established_date DATE,                 -- 成立日期
  registered_capital TEXT,               -- 注册资本
  industry TEXT,                         -- 一级产业
  industry_sub TEXT,                     -- 二级产业
  industry_tags TEXT[],                  -- 产业标签数组
  supply_chain_position TEXT,            -- 产业链位置
  development_stage TEXT,                -- 发展阶段
  employee_count INTEGER,               -- 员工数
  description TEXT,                      -- 一句话描述
  source TEXT,                           -- 数据来源（企业数据库/走访/企查查）
  is_in_park BOOLEAN DEFAULT true,       -- 是否在漕河泾范围内
  is_incubated BOOLEAN DEFAULT false,    -- 是否孵化企业
  last_visited_at TIMESTAMPTZ,           -- 最近走访时间
  ai_summary TEXT,                       -- AI 生成的企业摘要
  raw_data JSONB,                        -- 原始数据（灵活字段）
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ========================================
-- 走访记录表（客户拜访 + 政策触达共用）
-- ========================================
CREATE TABLE visit_records (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  enterprise_id UUID REFERENCES enterprises(id),
  visitor_name TEXT NOT NULL,            -- 走访人
  visitor_department TEXT,               -- 走访人部门
  visit_date DATE NOT NULL,              -- 走访日期
  visit_type TEXT,                       -- 走访类型：招商/科创/园发/孵化
  counterpart_name TEXT,                 -- 对方接待人
  counterpart_title TEXT,                -- 对方职务
  feishu_minute_id TEXT,                 -- 飞书妙记 ID
  ai_extracted JSONB,                    -- AI 提取的结构化内容
  key_findings TEXT[],                   -- 关键发现
  demands TEXT[],                        -- 企业诉求
  follow_up TEXT,                        -- 下一步计划
  human_notes TEXT,                      -- 人工补充
  key_question_coverage JSONB,           -- 关键问题覆盖度
  is_confirmed BOOLEAN DEFAULT false,    -- 是否已确认
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ========================================
-- 背调报告表
-- ========================================
CREATE TABLE background_reports (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  enterprise_id UUID REFERENCES enterprises(id),
  created_by TEXT,                       -- 生成人
  report_content JSONB NOT NULL,         -- 报告内容（结构化 JSON）
  feishu_doc_url TEXT,                   -- 飞书文档链接
  communication_checklist JSONB,         -- 沟通清单
  status TEXT DEFAULT 'draft',           -- draft/published
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ========================================
-- 政策评估表
-- ========================================
CREATE TABLE policy_assessments (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  enterprise_id UUID REFERENCES enterprises(id),
  policy_type TEXT NOT NULL,             -- 政策类型：高新/专精特新/...
  screening_result TEXT,                 -- 初筛结果：pass/fail/pending
  screening_details JSONB,              -- 初筛各项详情
  grade TEXT,                            -- 分级：A/B/C
  grade_score NUMERIC,                   -- 分级得分
  grade_details JSONB,                   -- 分级各项详情
  diagnosis_result JSONB,                -- 诊断报告
  touch_status TEXT DEFAULT 'pending',   -- 触达状态：pending/assigned/visited/willing/unwilling
  assigned_to TEXT,                       -- 分配给谁
  task_feishu_id TEXT,                   -- 飞书任务 ID
  final_result TEXT,                     -- 最终结果：approved/rejected/pending
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ========================================
-- 政策规则配置表
-- ========================================
CREATE TABLE policy_rules (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  policy_type TEXT NOT NULL,             -- 政策类型
  rule_name TEXT NOT NULL,               -- 规则名称
  rule_type TEXT,                        -- hard/soft（硬性/软性）
  rule_description TEXT,                 -- 规则描述
  evaluation_criteria TEXT,              -- 评判标准
  max_score NUMERIC,                     -- 最高分
  data_source TEXT,                      -- 数据来源字段
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ========================================
-- 订单匹配表（孵化器）
-- ========================================
CREATE TABLE incubator_matches (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  query_text TEXT NOT NULL,              -- 用户查询原文
  query_type TEXT,                       -- demand_to_incubator / incubator_to_park
  source_enterprise_id UUID REFERENCES enterprises(id),  -- 需求方企业
  matched_enterprises JSONB,             -- 匹配结果列表
  relationship_graph JSONB,              -- 关系网图数据
  created_by TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ========================================
-- 系统配置表
-- ========================================
CREATE TABLE system_configs (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  config_type TEXT NOT NULL,             -- track_questions / policy_talk / department_map / service_list
  config_name TEXT NOT NULL,             -- 配置名称
  config_data JSONB NOT NULL,            -- 配置内容
  is_active BOOLEAN DEFAULT true,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 3.2 数据关系

```
enterprises (1) ──── (N) visit_records
enterprises (1) ──── (N) background_reports
enterprises (1) ──── (N) policy_assessments
enterprises (1) ──── (N) incubator_matches (source)
enterprises (N) ──── (N) incubator_matches (matched)
policy_rules (1) ──── (N) policy_assessments (through policy_type)
system_configs ──── standalone
```

---

## 四、Agent 清单

| Agent | 所属场景 | 触发方式 | 核心能力 | 版本 |
|-------|---------|---------|---------|------|
| 背调报告 Agent | 客户拜访 | 用户点击"生成背调" | 整合企业数据 → 生成背调文档 + 沟通清单 | 0.1 |
| 走访记录 Agent | 客户拜访 | 妙记关联后自动触发 | 解析妙记 → 提取结构化走访记录 | 0.2 |
| 政策初筛 Agent | 政策服务 | 用户点击"开始筛选" / 新企业入库触发 | 根据 rubrics 批量评估企业 | 0.1 |
| 政策诊断 Agent | 政策服务 | 用户上传材料后触发 | 根据 rubrics 逐项审核材料 | 0.2 |
| 订单匹配 Agent | 孵化器 | 用户对话式输入 | 需求拆解 → 企业匹配 → 关系分析 | 0.1 |
| Deep Research Agent | 共用 | 被其他 Agent 调用 | 从公开互联网搜集企业信息 | 0.1 |

---

## 五、迭代路线

### 0.1 版（2/24 - 3/6）—— 核心骨架

```
✅ 企业画像页（基本信息 Tab）
✅ 背调报告生成（输入企业名 → 输出飞书文档）
✅ 政策初筛（上传规则 → 批量筛企业 → 输出名单）
✅ 订单匹配（对话式输入 → 输出匹配列表）
✅ 企业数据库 dump → Supabase
✅ 孵化企业 BP 解析 → Supabase
```

### 0.2 版（3/7 - 3/20）—— 数据闭环

```
✅ 妙记自动关联 + 走访记录生成
✅ 关键问题检测（3+3 覆盖度）
✅ 政策分级 + 触达任务分发（飞书任务）
✅ 关系网可视化页面
✅ 高活跃企业报告
✅ 企业画像页（走访记录 Tab / 政策状态 Tab）
```

### 0.3 版（3/21 - 4/3）—— 补全体验

```
✅ 需求清单整理 + 任务分发
✅ 跨部门信息同步（走访推送）
✅ 政策诊断（材料审核）
✅ 管理看板（统计页面）
✅ 走访记录调整（人工补充）
```

---

## 六、技术约束

| 约束 | 说明 |
|------|------|
| 框架 | Next.js 14 + App Router |
| UI | @north/design + shadcn/ui + Tailwind |
| 语言 | TypeScript 严格模式 |
| 数据库 | Supabase (PostgreSQL + RLS + Realtime) |
| 状态管理 | Zustand |
| 通信 | SDK Context（sendChat → Agent → supabase_tool → Realtime） |
| 认证 | SDK Context 提供用户身份 |
| 部署 | 嵌入小北驾驶舱 iframe |
