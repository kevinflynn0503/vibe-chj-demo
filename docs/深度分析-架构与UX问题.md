# 漕河泾驾驶舱 — 架构与 UX 深度分析

> 日期：2026-02-10
> 目标：诊断当前 Demo 的架构问题，评估"嵌入小北"的可行性，并给出优化方案

---

## 一、核心问题总结

| # | 问题 | 严重程度 | 影响 |
|---|------|---------|------|
| 1 | 用户第一眼不知道这个产品是干什么的、怎么用 | 🔴 高 | 无法快速传递产品价值 |
| 2 | 三个 App 之间存在复杂且混乱的跳转关系 | 🔴 高 | 用户迷路，认知负荷大 |
| 3 | visit-app 同时承担"门户"和"业务 App"两个角色 | 🟡 中 | 职责不清，代码耦合 |
| 4 | 当前架构不适合直接嵌入小北 iframe | 🔴 高 | 需要较大改造才能上线 |

---

## 二、逐项深度分析

### 2.1 问题一：用户第一眼不知道怎么用

#### 现状描述

当前首页（工作台 Dashboard）的内容结构：

```
┌───────────────────────────────────────┐
│  工作台                                │  ← 标题，没有说明"你是谁"
│  漕河泾开发区智能招商服务平台            │  ← 副标题，太泛
├───────────────────────────────────────┤
│  ⚠ 3 条走访记录待确认 / 2 条需求待处理   │  ← 待办提醒（好的设计）
├───────────────────────────────────────┤
│  [园区企业 1,248] [已走访 376] [A级 47] [在孵 5]  │  ← 4个指标卡片
├───────────────────────────────────────┤
│  快捷操作                              │
│  [生成背调报告] [开始政策筛选] [订单匹配]  │  ← 3个快捷入口
├───────────────────────────────────────┤
│  [最近走访]        [孵化企业活跃度]       │  ← 两栏内容
└───────────────────────────────────────┘
```

#### 问题分析

1. **缺少"你好，XXX"的个性化欢迎**：用户进来不知道自己的角色是什么，看到一堆数字无从下手
2. **四个指标卡片地位平等**：园区企业、走访、政策、孵化四个数字并排，但用户可能只关心其中一个场景。招商经理不需要看孵化器数据，孵化器运营不需要看政策筛选
3. **快捷操作缺少场景引导**：三个按钮并排呈现，没有告诉用户"你当前最应该做什么"
4. **没有"角色-任务"映射**：产品架构文档明确定义了三类核心用户（招商经理、项目经理、孵化器运营），但首页没有针对不同角色做任何区分
5. **信息密度高但指引性差**：堆了很多数据，但没有回答"我现在应该做什么"

#### 对比行业最佳实践

好的工作台首页应该做到：
- **5 秒内让用户知道自己该做什么**（待办事项 + 个性化推荐）
- **根据角色展示不同内容**（或者至少可配置）
- **清晰的行动号召（CTA）**而非平铺信息

---

### 2.2 问题二：三个 App 之间的复杂跳转

#### 现状架构

```
┌──────────────────────────────────────────────┐
│                visit-app (port 3333)          │
│  充当"统一门户" + "客户拜访"双重角色           │
│                                               │
│  路由:                                        │
│    /              → 工作台 Dashboard           │
│    /enterprises   → 企业画像库                 │
│    /visit         → 客户拜访                   │
│    /policy        → 政策服务 (visit-app 版)    │  ← 🔴 重复！
│    /incubator     → 孵化器管理 (visit-app 版)  │  ← 🔴 重复！
│    /policy/screening/[id]  → 筛选详情          │
│    /incubator/match        → 订单匹配          │
└──────────────────────────────────────────────┘

┌──────────────────────────────────────────────┐
│              policy-app (port 3334)            │
│  独立的政策服务 App                             │
│                                               │
│  路由:                                        │
│    /              → 政策服务 Dashboard          │  ← 🔴 和 visit-app 的 /policy 功能重叠
│    /screening/[id] → 筛选详情                  │
└──────────────────────────────────────────────┘

┌──────────────────────────────────────────────┐
│            incubator-app (port 3335)           │
│  独立的孵化器管理 App                           │
│                                               │
│  路由:                                        │
│    /              → 孵化器 Dashboard            │  ← 🔴 和 visit-app 的 /incubator 功能重叠
│    /match         → 订单匹配                   │
└──────────────────────────────────────────────┘
```

#### 问题分析

1. **功能重复（最严重）**：
   - `visit-app/policy/page.tsx`（148 行）和 `policy-app/(root)/page.tsx`（235 行）是**同一个功能的两个版本**
   - `visit-app/incubator/page.tsx`（81 行）和 `incubator-app/(root)/page.tsx`（192 行）也是**同一个功能的两个版本**
   - 两个版本样式不统一（visit-app 用硬编码颜色 `#3370ff`，独立 App 用 CSS 变量 `text-primary`）
   - 未来维护时改了一个忘了改另一个，必定出 bug

2. **跳转关系混乱**：
   - 用户在 visit-app 的侧边栏点"政策服务"→ 进入 `/policy`（visit-app 内置版）
   - 但如果从小北打开 policy-app → 进入 `localhost:3334`（独立版）
   - 两个页面长得不一样，功能也有差异，用户会困惑"哪个才是真的？"

3. **没有实际的跨 App 通信**：
   - 三个 App 运行在不同端口，共享零数据
   - 没有 iframe 嵌套、没有 postMessage、没有共享 Session
   - 如果用户在 policy-app 做了操作，visit-app 的 Dashboard 不会更新

4. **侧边栏导航的"假统一"**：
   - visit-app 的侧边栏看起来像是统一入口，包含了所有 5 个模块
   - 但实际上点进"政策服务"和"孵化器管理"后，展示的是 visit-app 内部的简化版，不是真正的 policy-app/incubator-app
   - 这意味着侧边栏制造了"一体化"的假象，实际架构是分裂的

#### 跳转关系图

```
用户入口 1: visit-app 侧边栏
  工作台     → visit-app /
  企业画像库  → visit-app /enterprises
  客户拜访    → visit-app /visit
  政策服务    → visit-app /policy           ← 简化版 ❌
  孵化器管理  → visit-app /incubator        ← 简化版 ❌

用户入口 2: 从小北打开 policy-app
  政策服务    → policy-app /               ← 完整版 ✅
  筛选详情    → policy-app /screening/[id]

用户入口 3: 从小北打开 incubator-app
  孵化器管理  → incubator-app /            ← 完整版 ✅
  订单匹配    → incubator-app /match

🔴 问题：同一个用户可能从两条路径进入"政策服务"，看到不同的界面
```

---

### 2.3 问题三：visit-app 的角色冲突

#### 现状

visit-app 目前承担了两个完全不同的职责：

| 职责 | 说明 | 应该是 |
|------|------|--------|
| 统一门户 | 提供侧边栏、Dashboard、统一导航 | 一个轻量的 Shell / Portal |
| 客户拜访业务 | 企业画像库、走访记录、背调报告 | 一个专注的业务 App |

这导致了：
- 侧边栏导航写在 visit-app 的 layout 里，如果 policy-app 想要同样的侧边栏，要么复制代码，要么放弃独立
- 企业画像作为"公共模块"被设计文档定义，但实际只存在于 visit-app 的 `/enterprises` 路由下
- visit-app 的 `package.json` 包含了所有依赖，但 policy-app 和 incubator-app 也各自安装了一份相同的依赖

---

### 2.4 问题四：嵌入小北的可行性评估

#### 产品设计文档的意图

根据 `产品功能架构.md`：
> **部署：嵌入小北驾驶舱 iframe**

根据 `sdk-context.tsx`：
> 已集成 `@north/north-client-sdk`，支持 iframe 通信

#### 当前状态 vs 嵌入需求

| 需求 | 当前状态 | 差距 |
|------|---------|------|
| 每个 App 可独立嵌入 iframe | ✅ 三个独立 Next.js App | 基本满足 |
| App 内部导航不破坏 iframe | ⚠️ 使用 `router.push()`，会在 iframe 内跳转 | 需要验证 |
| 顶部导航由小北提供 | ❌ visit-app 自带侧边栏，视觉冲突 | 🔴 必须解决 |
| 跨 App 跳转由小北控制 | ❌ visit-app 侧边栏直接 `router.push` 切换页面 | 🔴 必须解决 |
| 共享企业画像页 | ❌ 只在 visit-app 中，policy-app/incubator-app 无法访问 | 🔴 必须解决 |
| App 可以感知小北上下文 | ⚠️ SDK Context 已定义但未实际使用 | 需要开发 |
| 响应式适配 iframe 尺寸 | ❌ 固定布局，无响应式 | 需要适配 |

#### 核心矛盾

**小北的导航模式 vs 当前的侧边栏模式**：

如果嵌入小北 iframe，小北自己有一套导航体系（顶部标签页/App 切换器）。但 visit-app 自带了完整的侧边栏导航，两者会冲突：

```
┌─ 小北驾驶舱 ──────────────────────────────────┐
│  [客户拜访] [政策服务] [孵化器管理]  ← 小北的Tab │
│ ┌──────────────────────────────────────────┐ │
│ │ ┌─────────┐ ┌──────────────────────────┐ │ │
│ │ │ 工作台   │ │                          │ │ │
│ │ │ 企业画像 │ │   visit-app 内容区       │ │ │
│ │ │ 客户拜访 │ │                          │ │ │  ← 两层导航！
│ │ │ 政策服务 │ │                          │ │ │
│ │ │ 孵化器  │ │                          │ │ │
│ │ └─────────┘ └──────────────────────────┘ │ │
│ │  ↑ visit-app 自己的侧边栏                  │ │
│ └──────────────────────────────────────────┘ │
│     ↑ iframe                                  │
└───────────────────────────────────────────────┘

🔴 问题：用户看到两层导航，不知道该用哪个
🔴 问题：visit-app 侧边栏的"政策服务"和小北 Tab 的"政策服务"指向不同的东西
```

---

## 三、根因分析

回到根本原因，这些问题源于**一个核心矛盾**：

> **产品设计说"三个独立 App 嵌入小北 iframe"，但 Demo 实现成了"visit-app 当门户统管三个模块"**

这导致了：
- visit-app 包含了本不该有的政策/孵化器页面（为了 Demo 展示完整流程）
- policy-app / incubator-app 作为独立 App 存在，但和 visit-app 内嵌版本功能重复
- 没有一个真正的"门户 Shell"来统一管理 App 切换
- 侧边栏导航在嵌入小北后会产生冲突

---

## 四、优化方案

### 方案 A：标签页模式（推荐）

**思路**：模拟浏览器标签页，用顶部 Tab 切换不同模块，去掉侧边栏

```
┌────────────────────────────────────────────────────┐
│  漕河泾驾驶舱                                       │
│  ┌──────┐ ┌────────┐ ┌────────┐ ┌──────────┐       │
│  │ 工作台 │ │ 企业画像 │ │ 政策服务 │ │ 孵化器管理 │  ×   │  ← 标签页
│  └──┬───┘ └────────┘ └────────┘ └──────────┘       │
├─────┴──────────────────────────────────────────────┤
│                                                     │
│   当前标签页的内容                                    │
│                                                     │
└─────────────────────────────────────────────────────┘
```

**优点**：
- 用户一目了然看到所有功能模块
- 标签页可以保持状态（切换回来不丢失）
- 嵌入小北时，小北的标签栏可以直接替代
- 更符合"工具型应用"的心智模型

**改造点**：
1. 去掉 visit-app 的侧边栏 layout，改为顶部标签栏
2. 删除 visit-app 中重复的 `/policy` 和 `/incubator` 页面
3. policy-app 和 incubator-app 通过标签页或 iframe 加载
4. 或者合并为一个 App，用路由分组代替多 App

---

### 方案 B：合并为单 App + 路由分组

**思路**：既然三个 App 技术栈完全一致、数据也共享，不如合并为一个 Next.js App

```
visit-app/src/app/
├── (portal)/
│   ├── layout.tsx          ← 统一的顶部 Tab 导航
│   ├── page.tsx            ← 工作台
│   ├── enterprises/        ← 企业画像（公共）
│   ├── visit/              ← 客户拜访
│   ├── policy/             ← 政策服务（吸收 policy-app）
│   └── incubator/          ← 孵化器管理（吸收 incubator-app）
```

**优点**：
- 零跨 App 通信问题
- 共享企业画像页天然可用
- 导航逻辑简单清晰
- 部署和维护成本低

**缺点**：
- 嵌入小北时只有一个 iframe，小北的 App 切换器意义减弱
- 包体积稍大（但对内部工具影响不大）

**评估**：如果小北只需要嵌入"一个漕河泾 App"，这是最简单的方案。

---

### 方案 C：微前端 Shell + 独立 App

**思路**：做一个轻量 Shell（只有标签栏 + iframe 容器），三个 App 通过 iframe 嵌入

```
┌─ shell-app ────────────────────────────────────────┐
│  [工作台] [企业画像] [客户拜访] [政策服务] [孵化器]    │  ← Shell 标签栏
│ ┌────────────────────────────────────────────────┐  │
│ │                                                │  │
│ │  <iframe src="visit-app" />                    │  │  ← 每个 Tab 一个 iframe
│ │  或 <iframe src="policy-app" />                │  │
│ │  或 <iframe src="incubator-app" />             │  │
│ │                                                │  │
│ └────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
```

**优点**：
- 三个 App 真正独立，团队可以并行开发
- 嵌入小北时，小北直接替代 Shell 的角色
- 符合产品设计文档的原始意图

**缺点**：
- 开发复杂度最高
- iframe 间通信需要 postMessage
- 共享企业画像页需要每个 App 都能展示，或通过 Shell 路由

---

### 方案对比

| 维度 | 方案 A: 标签页 | 方案 B: 单 App | 方案 C: 微前端 |
|------|------------|------------|------------|
| 开发工作量 | 🟡 中等 | 🟢 最少 | 🔴 最大 |
| 用户体验 | 🟢 好 | 🟢 好 | 🟡 中等（iframe 有坑） |
| 嵌入小北 | 🟢 容易适配 | 🟢 最容易 | 🟡 需要协调 |
| 独立部署 | 🟡 需要协调 | ❌ 单体 | 🟢 完全独立 |
| 长期维护 | 🟢 清晰 | 🟢 简单 | 🟡 复杂 |

**推荐**：先采用 **方案 B（合并为单 App）** 快速解决当前问题，然后在单 App 内用 **方案 A 的标签页 UI** 来组织导航。

---

## 五、首页优化建议

### 5.1 当前首页 → 优化后首页

```
优化前：                              优化后：
┌──────────────────┐                ┌──────────────────────────┐
│ 工作台            │                │ 👋 你好，张经理           │
│ (一堆数字)        │                │ 今天有 3 件事需要你处理    │
│                   │                ├──────────────────────────┤
│ [1248] [376] ...  │                │ 📋 待办清单               │
│                   │     →          │  ☐ 确认 3 条走访记录      │
│ 快捷操作          │                │  ☐ 处理 2 条企业需求      │
│ [背调] [政策] ... │                │  ☐ 查看新入库的 5 家企业   │
│                   │                ├──────────────────────────┤
│ 最近走访 | 活跃度  │                │ 🚀 快速开始               │
│                   │                │  → 企业画像库 (1,248 家)  │
└──────────────────┘                │  → 我的走访记录           │
                                     │  → 生成背调报告           │
                                     ├──────────────────────────┤
                                     │ 📊 本周概况 (可折叠)      │
                                     │  走访覆盖率: 30.1%       │
                                     │  新增走访: +12           │
                                     └──────────────────────────┘
```

### 5.2 优化要点

1. **个性化欢迎 + 角色感知**
   - "你好，张经理（招商组）"
   - 根据角色显示不同的首页内容

2. **待办驱动而非数据驱动**
   - 首屏第一优先级：你现在需要做什么
   - 把待办从一个小黄条提升为主要内容区

3. **减少信息密度**
   - 当前 4 个指标 + 3 个快捷操作 + 2 个列表 = 信息量过大
   - 聚焦到 3-5 个最重要的动作

4. **渐进式引导**
   - 新用户首次进入：显示引导步骤
   - "第一步：浏览企业画像库 → 第二步：生成你的第一份背调 → 第三步：记录走访"

---

## 六、标签页导航详细设计

### 6.1 标签页行为规范

```
┌─────────────────────────────────────────────────────────────┐
│  漕河泾驾驶舱           [工作台] [企业画像库 ×] [政策服务 ×]  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   当前激活标签的内容                                          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

| 行为 | 说明 |
|------|------|
| 点击侧栏/首页入口 | 如果目标模块已打开 → 切换到对应标签；否则 → 新建标签 |
| 关闭标签（×） | 回到上一个激活的标签；工作台标签不可关闭 |
| 刷新页面 | 标签状态持久化到 URL hash 或 sessionStorage |
| 最多标签数 | 限制 5-6 个，超出时提示关闭不用的 |
| 标签顺序 | 工作台固定在第一位，其他按打开顺序 |

### 6.2 与小北的对接方式

当嵌入小北 iframe 时：
- 隐藏应用自身的标签栏（通过 URL 参数 `?embedded=true` 控制）
- 标签切换通过 `postMessage` / SDK 通知小北
- 小北负责渲染顶部标签栏
- 应用只渲染内容区

```typescript
// 伪代码：嵌入模式检测
const isEmbedded = searchParams.get('embedded') === 'true';

// Layout 中：
if (isEmbedded) {
  return <main>{children}</main>;  // 无侧边栏/标签栏
} else {
  return (
    <div>
      <TabBar tabs={openTabs} />      // 自带标签栏
      <main>{children}</main>
    </div>
  );
}
```

---

## 七、改造优先级与实施建议

### Phase 1：基础整合（1-2 天）

| 任务 | 说明 |
|------|------|
| 合并三个 App 为单 App | 把 policy-app 和 incubator-app 的完整版页面合并到 visit-app |
| 删除重复页面 | 删除 visit-app 中的简化版 `/policy` 和 `/incubator` |
| 统一样式变量 | 统一使用 CSS 变量，消除硬编码颜色 |

### Phase 2：导航改造（1-2 天）

| 任务 | 说明 |
|------|------|
| 侧边栏 → 顶部标签栏 | 替换 layout.tsx 的侧边栏为顶部标签页 |
| 实现标签页状态管理 | 用 Zustand 管理打开的标签、激活状态 |
| 添加嵌入模式支持 | `?embedded=true` 时隐藏标签栏 |

### Phase 3：首页优化（1 天）

| 任务 | 说明 |
|------|------|
| 首页改为待办驱动 | 重构 Dashboard，突出待办事项 |
| 添加角色感知 | 根据用户角色展示不同内容 |
| 精简信息密度 | 减少首屏内容量，突出核心 CTA |

### Phase 4：小北对接（按需）

| 任务 | 说明 |
|------|------|
| SDK Context 实际集成 | 接入真实的 `@north/north-client-sdk` |
| postMessage 通信 | 实现与小北的标签页同步 |
| 状态持久化 | iframe 刷新后恢复状态 |

---

## 八、关于"模拟浏览器标签页"的具体设计

用户提到"模拟浏览器顶部的标签页"，这是一个很好的方向。具体设计建议：

### 8.1 标签页的信息层级

```
左侧 Logo + 名称             中间标签区域                    右侧功能区
┌──────────────┬────────────────────────────────────────┬──────────┐
│  🏢 漕河泾    │ [📊 工作台] [🏢 企业画像库 ×] [🛡 政策 ×]  │  👤 张经理 │
└──────────────┴────────────────────────────────────────┴──────────┘
```

### 8.2 标签页支持的页面类型

| 类型 | 标签标题示例 | 可否关闭 | 说明 |
|------|-----------|---------|------|
| 工作台 | "工作台" | ❌ | 常驻首页，永远存在 |
| 模块列表 | "企业画像库" | ✅ | 各模块的列表页 |
| 详情页 | "优刻得科技 - 画像" | ✅ | 点击列表项后打开的详情 |
| 功能页 | "订单匹配" | ✅ | 特殊功能页面 |

### 8.3 关键交互

- **从列表打开详情**：在新标签中打开企业详情页（而不是替换当前标签），方便对比
- **返回列表**：关闭详情标签，自动回到列表标签
- **面包屑与标签配合**：标签表示"窗口"，面包屑表示"当前窗口内的路径"

---

## 九、结论

### 当前最大的问题

**不是 UI 不好看，而是架构和导航逻辑让用户迷路。** 三个独立 App + visit-app 充当门户的架构，在 Demo 阶段看似完整，但：
- 功能重复导致维护负担翻倍
- 跳转逻辑不统一导致用户困惑
- 与小北嵌入的目标冲突

### 建议的行动

1. **立即做**：合并为单 App，消除重复代码
2. **紧接着**：侧边栏改为顶部标签页，支持嵌入模式
3. **然后**：优化首页为待办驱动
4. **最后**：接入小北 SDK 实现真正的 iframe 嵌入

这样既解决了当前的 UX 问题，又为嵌入小北做好了准备。
