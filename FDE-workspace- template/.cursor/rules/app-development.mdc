---
description: 开发 north-app 代码时自动加载的技术约束和铁律
globs: projects/*/apps/**
alwaysApply: false
---

# App 开发规则

操作项目 `apps/` 目录下的代码时，必须遵守以下规则。详细指南参考 `skills/north-app/SKILL.md`。

## 10 条铁律

违反以下规则必然导致 Bug：

1. **SDK 必须传 `getState`** — 否则 iframe 无法获取用户信息
2. **用 `useRef(hostAPI)` 防循环** — 否则 useEffect 无限触发
3. **查询必须 `.eq('user_id', userId)`** — 否则数据泄露
4. **Realtime 必配轮询 fallback** — 否则网络抖动时丢数据
5. **自动保存必须有保存锁** — 否则竞争条件覆盖新数据
6. **版本号 = `MAX + 1`** — 禁止用 `count + 1`（删除后重复）
7. **完整内容直存 `content` 字段** — 禁止依赖远程文件链
8. **日志用 logger，不用 `console.log`** — 通过 `LOG_LEVEL` 环境变量控制
9. **公共代码提到 `@north/app-common`** — 禁止跨应用 copy-paste
10. **CSP headers + `reactStrictMode: true`** — next.config.js 必须配置

## 新建 App 流程

1. 从 `skills/north-app/app-template/` 复制到 `projects/[项目名]/apps/[app-name]/`
2. 全局替换 `your-app-name` 为实际名称
3. 修改 `next.config.js` 的 `basePath`
4. 修改 `public/xiaobei-manifest.json` 的 `appId`
5. 修改 `supabase-schema.sql` 的表结构
6. 修改 `src/lib/supabase.ts` 的 `TABLE_NAME` 和 CRUD
7. 在 Supabase Dashboard 执行 SQL

## 代码规范

- 禁止 `any`，使用 `unknown`
- 对象类型用 `interface`，联合类型用 `type`
- 函数组件 + Hooks，禁止 class 组件
- 条件渲染顺序: loading → error → empty → data
- 表名复数（projects, tasks）、字段 snake_case（created_at）
