# 飞书联动方案 - 漕河泾

> 漕河泾的业务全部运行在飞书生态上。本文档描述 App 层和 Agent 层如何与飞书各模块交互。

---

## 一、联动全景

```
┌────────────────────────────────────────────────────────┐
│                       飞书平台                          │
│                                                        │
│  ┌──────────┐  ┌──────────┐  ┌──────┐  ┌───────────┐  │
│  │ 飞书妙记  │  │ 飞书日历  │  │ 任务  │  │ 文档/多维  │  │
│  └─────┬────┘  └─────┬────┘  └──┬───┘  └─────┬─────┘  │
│        │             │          │             │        │
│  ──────┼─────────────┼──────────┼─────────────┼──────  │
│        │   feishu_agent（统一飞书工具）         │        │
│        │             │          │             │        │
└────────┼─────────────┼──────────┼─────────────┼────────┘
         │             │          │             │
┌────────┼─────────────┼──────────┼─────────────┼────────┐
│  Agent │             │          │             │        │
│  ┌─────▼────┐  ┌─────▽────┐  ┌─▽─────┐  ┌───▽─────┐  │
│  │走访记录   │  │背调报告   │  │政策触达│  │数据同步  │  │
│  │Agent     │  │Agent     │  │Agent  │  │Agent    │  │
│  └─────┬────┘  └─────┬────┘  └──┬────┘  └───┬─────┘  │
│        │             │          │            │        │
│  ──────┼─────────────┼──────────┼────────────┼──────  │
│        │       supabase_tool                  │        │
│        │             │          │            │        │
│  ┌─────▽─────────────▽──────────▽────────────▽─────┐  │
│  │                  Supabase 数据库                  │  │
│  └──────────────────────┬───────────────────────────┘  │
│                         │                              │
│  ┌──────────────────────▽───────────────────────────┐  │
│  │                    App 前端                       │  │
│  │         (Realtime 订阅 → 实时展示)               │  │
│  └──────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────┘
```

**核心设计**：App 前端 **不直接调飞书 API**。所有飞书交互都经过 Agent → `feishu_agent` 工具完成。App 只通过 Supabase Realtime 获取结果。

---

## 二、飞书妙记联动

### 用在哪

| 场景 | 触发时机 | 做什么 |
|------|---------|--------|
| 客户拜访 | 走访结束后 | 获取妙记转录 → AI提取走访记录 |
| 政策服务 | 政策触达走访后 | 获取妙记转录 → 提取政策相关信息 |

### 数据流

```
招商经理拜访时开妙记
         │
         ▼
飞书妙记完成转录（飞书侧）
         │
         ▼  ① 定时轮询 / Webhook 监听
走访记录 Agent 检测到新妙记
         │
         ▼  ② feishu_agent.get_minute(minute_id)
获取妙记转录文本 + 参会人 + 时间
         │
         ▼  ③ feishu_agent.get_calendar_events(time_range)
根据时间和参会人匹配日历中的拜访日程
         │
         ▼  ④ 匹配成功？
    ┌────┴────┐
    │ 是      │ 否
    ▼         ▼
关联企业    推送消息给用户
    │       "这条妙记无法自动关联，
    ▼        请手动选择对应企业"
AI 分析妙记内容
    │
    ▼  ⑤ supabase_tool.insert(visit_records)
写入走访记录（is_confirmed=false）
    │
    ▼  ⑥ App Realtime 收到更新
前端展示待确认的走访记录
```

### feishu_agent 调用

```yaml
# 获取妙记列表（按时间范围）
action: list_minutes
params:
  start_time: "2026-02-09T00:00:00Z"
  end_time: "2026-02-09T23:59:59Z"
  
# 获取妙记详情（转录文本）
action: get_minute
params:
  minute_id: "7xxxxx"
  
# 获取妙记转录段落
action: get_minute_transcript  
params:
  minute_id: "7xxxxx"
```

### App 前端交互

- **自动关联成功**：走访记录页出现一条新的"待确认"记录，用户点击查看 → 确认/调整
- **自动关联失败**：首页推送通知卡片"有一条新妙记未关联企业"，用户点击 → 选择企业 → 触发 Agent 处理
- **手动触发**：用户在企业画像页点击"关联妙记" → 输入妙记链接或选择最近的妙记

---

## 三、飞书日历联动

### 用在哪

| 场景 | 触发时机 | 做什么 |
|------|---------|--------|
| 客户拜访 | 用户创建拜访日程 | 识别拜访日程 → 关联妙记 |
| 政策服务 | 触达任务分发后 | 自动创建项目经理的走访日程 |

### 数据流

```
场景A：读取日历（用于妙记关联）
─────────────────────────────
走访记录 Agent
    │  feishu_agent.list_calendar_events(time_range, user_id)
    ▼
获取拜访日程列表
    │  解析日程标题 / 参会人 / 地点 → 推断对应企业
    ▼
与妙记时间匹配 → 关联


场景B：创建日历（用于触达任务）
─────────────────────────────
政策触达 Agent
    │  确定项目经理 + 企业 + 建议时间
    ▼
    │  feishu_agent.create_calendar_event(
    │    summary: "走访[企业名]-政策触达",
    │    attendees: [项目经理ID],
    │    description: "请重点确认以下问题：1.xx 2.xx 3.xx"
    │  )
    ▼
飞书日历中出现拜访日程
```

### feishu_agent 调用

```yaml
# 获取日历事件
action: list_calendar_events
params:
  calendar_id: "primary"
  start_time: "2026-02-09T00:00:00Z"
  end_time: "2026-02-15T23:59:59Z"

# 创建日历事件
action: create_calendar_event
params:
  summary: "走访强生医疗-政策触达"
  start_time: "2026-02-12T14:00:00+08:00"
  end_time: "2026-02-12T15:00:00+08:00"
  attendees: ["user_id_xxx"]
  description: "请重点确认：1.研发费用占比 2.知识产权数量 3.高新收入占比"
```

---

## 四、飞书任务联动

### 用在哪

| 场景 | 触发时机 | 做什么 |
|------|---------|--------|
| 政策服务 | 初筛完成后 | 给项目经理分发走访任务 |
| 客户拜访 | 需求确认后 | 给对应部门分发跟进任务 |

### 数据流

```
政策初筛完成 → A 级企业 10 家
         │
         ▼
政策触达 Agent 批量创建任务
         │
         ▼  对每家 A 级企业：
    feishu_agent.create_task(
      summary: "[政策触达] 走访XX公司-高新认定",
      description: "该企业初筛为A级，请3天内完成走访...",
      assignee: "项目经理_user_id",
      due_date: "2026-02-12",
      origin: { href: "app://policy-app/enterprises/xxx" }
    )
         │
         ▼
    supabase_tool.update(
      table: policy_assessments,
      filters: { enterprise_id: "xxx" },
      data: { touch_status: "assigned", task_feishu_id: "task_xxx" }
    )
         │
         ▼
    App Realtime → 前端触达任务列表更新
```

### feishu_agent 调用

```yaml
# 创建任务
action: create_task
params:
  summary: "[政策触达] 走访强生医疗-高新认定"
  description: |
    初筛结果：A级（85分）
    请重点确认：
    1. 研发费用占总收入比例
    2. 近三年知识产权获取情况
    3. 高新技术产品收入占比
  assignee: "user_id_xxx"
  due_date: "2026-02-12"
  
# 更新任务状态
action: update_task
params:
  task_id: "task_xxx"
  status: "completed"

# 查询任务列表  
action: list_tasks
params:
  assignee: "user_id_xxx"
  status: "open"
```

---

## 五、飞书文档联动

### 用在哪

| 场景 | 触发时机 | 做什么 |
|------|---------|--------|
| 客户拜访 | 生成背调报告 | 创建飞书文档写入背调内容 |

### 数据流

```
用户点击"生成背调"
         │
         ▼
背调报告 Agent 生成报告内容
         │
         ▼  ① 创建飞书文档
    feishu_agent.create_document(
      title: "[背调] 强生医疗 - 2026.02.09",
      folder_token: "走访背调文件夹token"
    )
         │
         ▼  ② 写入文档内容（按模块分段）
    feishu_agent.write_document_blocks(
      document_id: "doc_xxx",
      blocks: [
        { type: "heading1", content: "一、工商信息" },
        { type: "text", content: "..." },
        { type: "heading1", content: "二、股权情况" },
        ...
        { type: "heading1", content: "沟通清单" },
        { type: "callout", content: "必问问题：1.xx 2.xx 3.xx" }
      ]
    )
         │
         ▼  ③ 获取文档链接
    doc_url = "https://xxx.feishu.cn/docx/xxx"
         │
         ▼  ④ 写入 Supabase
    supabase_tool.insert(
      table: background_reports,
      data: { enterprise_id, report_content, feishu_doc_url: doc_url }
    )
         │
         ▼
    App 前端展示报告内容 + "在飞书中打开"链接
```

### feishu_agent 调用

```yaml
# 创建文档
action: create_document
params:
  title: "[背调] 强生医疗"
  folder_token: "fldxxx"

# 写入文档内容
action: write_document
params:
  document_id: "docxxx"
  content: "markdown格式的报告内容"

# 获取文档链接
action: get_document_url
params:
  document_id: "docxxx"
```

---

## 六、飞书多维表格联动

### 用在哪

| 场景 | 触发时机 | 做什么 |
|------|---------|--------|
| 共用 | 初始化数据 | 从多维表格批量导入企业/走访/配置数据 |
| 孵化器 | 读取数据 | 从孵化器多维表格获取企业清单 |

### 数据流

```
一次性数据导入（初始化阶段）：
    feishu_agent.list_bitable_records(
      app_token: "bitable_xxx",
      table_id: "tbl_xxx"
    )
         │
         ▼
    数据清洗 → 字段映射 → 批量写入 Supabase

定期增量同步：
    feishu_agent.list_bitable_records(
      app_token: "bitable_xxx",
      table_id: "tbl_xxx",
      filter: { field: "updated_at", operator: ">", value: "last_sync_time" }
    )
         │
         ▼
    增量更新 Supabase 对应记录
```

### feishu_agent 调用

```yaml
# 读取多维表格记录
action: list_bitable_records
params:
  app_token: "bitable_xxx"
  table_id: "tbl_xxx"
  page_size: 100
  filter:
    field_name: "更新时间"
    operator: ">"
    value: "2026-02-01"

# 写入多维表格（如需回填）
action: create_bitable_record
params:
  app_token: "bitable_xxx"
  table_id: "tbl_xxx"
  fields:
    企业名称: "北坡科技"
    走访日期: "2026-02-09"
    走访要点: "..."
```

---

## 七、飞书消息联动

### 用在哪

| 场景 | 触发时机 | 做什么 |
|------|---------|--------|
| 客户拜访 | 走访后 | 推送走访记录待确认通知 |
| 政策服务 | 筛选完成 | 推送筛选结果通知给科创负责人 |
| 跨部门 | 走访信息涉及其他部门 | 推送通知给相关部门 |

### feishu_agent 调用

```yaml
# 发送消息给个人
action: send_message
params:
  receive_id_type: "user_id"
  receive_id: "user_xxx"
  msg_type: "interactive"
  content:
    header:
      title: "走访记录待确认"
    elements:
      - tag: "div"
        text: "你对强生医疗的走访记录已生成，请确认。"
      - tag: "action"
        actions:
          - tag: "button"
            text: "查看并确认"
            url: "app://visit-app/visits/xxx"

# 发送消息到群
action: send_message
params:
  receive_id_type: "chat_id"
  receive_id: "oc_xxx"
  msg_type: "text"
  content: "政策初筛完成：A级 12 家 / B级 28 家 / C级 45 家"
```

---

## 八、联动汇总表

| 飞书模块 | 读/写 | Agent | 场景 | 版本 |
|---------|-------|-------|------|------|
| 妙记 | 读 | 走访记录 Agent | 客户拜访+政策 | 0.1 |
| 日历 | 读+写 | 走访记录 Agent / 政策触达 Agent | 客户拜访+政策 | 0.1 |
| 任务 | 写+读 | 政策触达 Agent / 需求闭环 | 政策+客户拜访 | 0.1 |
| 文档 | 写 | 背调报告 Agent | 客户拜访 | 0.1 |
| 多维表格 | 读 | 数据同步 Agent | 初始化/孵化器 | 0.1 |
| 消息 | 写 | 各 Agent | 通知推送 | 0.2 |

### 关键原则

1. **App 前端不直接调飞书 API**。全部经 Agent → feishu_agent 工具
2. **Agent 写 Supabase，App 通过 Realtime 获取结果**。飞书交互对 App 透明
3. **飞书文档/任务的链接存在 Supabase 中**。App 可以展示"在飞书中打开"
4. **频控兜底**：飞书 API 有频率限制，Agent 层做请求队列和退避重试
