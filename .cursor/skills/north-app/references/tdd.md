# TDD - 测试驱动开发

## 铁律

```
没有失败的测试，就没有生产代码
```

在测试之前写了代码？**删掉它。重新开始。**

---

## 红-绿-重构循环

```
┌──────────────────────────────────────────────┐
│                                              │
│      ┌──────┐                                │
│      │  红  │  写失败测试                    │
│      └──┬───┘                                │
│         │                                    │
│         ▼                                    │
│   ┌──────────┐                               │
│   │ 验证失败  │  是否正确失败？               │
│   └────┬─────┘                               │
│        │                                     │
│   否←──┴──→是                                │
│   │         │                                │
│   │         ▼                                │
│   │    ┌──────┐                              │
│   │    │  绿  │  最少代码                    │
│   │    └──┬───┘                              │
│   │       │                                  │
│   │       ▼                                  │
│   │  ┌──────────┐                            │
│   │  │ 验证通过  │  全部绿色？                │
│   │  └────┬─────┘                            │
│   │       │                                  │
│   │  否←──┴──→是                             │
│   │  │         │                             │
│   │  │         ▼                             │
│   │  │    ┌────────┐                         │
│   │  │    │  重构  │  清理代码               │
│   │  │    └────┬───┘                         │
│   │  │         │                             │
│   └──┴─────────┴──→ 下一个测试               │
│                                              │
└──────────────────────────────────────────────┘
```

---

## 红：写失败的测试

### 好的测试

```typescript
test('失败操作重试3次', async () => {
  let attempts = 0;
  const operation = () => {
    attempts++;
    if (attempts < 3) throw new Error('fail');
    return 'success';
  };

  const result = await retryOperation(operation);

  expect(result).toBe('success');
  expect(attempts).toBe(3);
});
```

**特点**：名称清晰、测试真实行为、只测一件事

### 差的测试

```typescript
test('重试有效', async () => {
  const mock = jest.fn()
    .mockRejectedValueOnce(new Error())
    .mockResolvedValueOnce('success');
  await retryOperation(mock);
  expect(mock).toHaveBeenCalledTimes(2);
});
```

**问题**：名称模糊、测试的是mock而非代码

---

## 验证红：看着它失败

**必须执行。绝不跳过。**

```bash
npm test path/to/test.test.ts
```

**确认**：
- 测试失败（不是报错）
- 失败消息符合预期
- 因为功能缺失而失败

---

## 绿：最少代码

写最简单的代码让测试通过。

```typescript
// ✅ 好的：刚好够通过
async function retryOperation<T>(fn: () => Promise<T>): Promise<T> {
  for (let i = 0; i < 3; i++) {
    try {
      return await fn();
    } catch (e) {
      if (i === 2) throw e;
    }
  }
  throw new Error('unreachable');
}
```

**规则**：不要添加功能、不要重构其他代码、不要超出测试要求"改进"

---

## 重构：清理代码

**只在绿色之后**：
- 消除重复
- 改进命名
- 提取辅助函数

**规则**：保持测试绿色，不要添加行为

---

## 常见借口

| 借口 | 现实 |
|------|------|
| "太简单不用测" | 简单代码也会坏。测试只要30秒。 |
| "我后面测" | 立即通过的测试什么都证明不了。 |
| "已经手动测过了" | 随机 ≠ 系统。没有记录，不能重跑。 |
| "删掉X小时太浪费" | 沉没成本谬误。保留未验证的代码是技术债。 |
| "TDD会拖慢我" | TDD比调试快。 |

---

## 警示信号

停下来重新开始：

- ⚠️ 测试之前写了代码
- ⚠️ 实现后补测试
- ⚠️ 测试立即通过
- ⚠️ 不能解释测试为什么失败
- ⚠️ "保留做参考"

---

## 验证清单

- [ ] 每个新函数/方法都有测试
- [ ] 看着每个测试在实现前失败
- [ ] 每个测试因预期原因失败
- [ ] 为每个测试写了最少的代码
- [ ] 所有测试通过
- [ ] 测试使用真实代码（只在不得已时用mock）
- [ ] 覆盖了边界情况和错误情况

**不能全部勾选？你跳过了TDD。重新开始。**
